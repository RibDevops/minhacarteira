{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Metas por Categoria{% endblock %}

{% block content %}
<div class="container my-4">
  <a href="{% url 'cal:meta_criar' %}" class="btn btn-success">Criar Nova Meta</a>
  <p></p>
  <h2 class="mb-4">Metas do mês: {{ mes_atual }}</h2>

  <!-- Navegação de meses -->
  <div class="d-flex justify-content-between flex-wrap mb-3 gap-2">
    <a href="?mes={{ mes_anterior.month }}&ano={{ mes_anterior.year }}" class="btn btn-outline-primary">
      <i class="bi bi-arrow-left-circle"></i> Mês anterior
    </a>
    <a href="?mes={{ mes_proximo.month }}&ano={{ mes_proximo.year }}" class="btn btn-outline-primary">
      Próximo mês <i class="bi bi-arrow-right-circle"></i>
    </a>
  </div>

  <!-- Formulário de nova meta -->
  <form method="POST" class="mb-4">
    {% csrf_token %}
    {{ form.as_p }}
    
  </form>



  <!-- Metas individuais -->
  {% if dados %}
    {% for d in dados %}
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5>
            <a href="{% url 'cal:meta_editar' d.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil-square"></i></a>
            <a href="{% url 'cal:meta_excluir' d.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
          </h5><strong>{{ d.categoria }}</strong> — Usou R$ {{ d.gasto|floatformat:2 }} do seu limite de R$ {{ d.limite|floatformat:2 }}
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-5 text-center">
              <canvas id="pizza{{ d.id }}" width="80" height="80"></canvas>
            </div>
            <div class="col-md-7">
              <div class="progress mb-2">
                <div class="progress-bar bg-{{ d.status }}" style="width: {{ d.percentual }}%">
                  {{ d.percentual }}%
                </div>
              </div>
              {% if d.transacoes %}
                <ul class="list-group list-group-sm">
                  {% for t in d.transacoes %}
                    <li class="list-group-item py-1">
                      {{ t.data|date:"d/m/Y" }} - {{ t.titulo }} — <strong>R$ {{ t.valor|floatformat:2 }}</strong>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted">Nenhuma transação nesta categoria.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>Nenhuma meta cadastrada para este mês.</p>
  {% endif %}
</div>

  <!-- Gráfico geral -->
  <div class="mb-5">
    <h4 class="mb-2">Resumo Geral das Metas</h4>
    <div style="height: 300px;">
      <canvas id="graficoGeralMetas"></canvas>
    </div>
  </div>
<!-- Exporta dados JSON para o gráfico geral -->
{{ grafico_labels|json_script:"grafico-metas-labels" }}

{{ grafico_valores|json_script:"grafico-metas-valores" }}


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Gráfico geral
    const labels = JSON.parse(document.getElementById("grafico-metas-labels").textContent);
    const valores = JSON.parse(document.getElementById("grafico-metas-valores").textContent);
    const cores = labels.map((_, i) => `hsl(${i * 45}, 70%, 60%)`);

    const ctx = document.getElementById("graficoGeralMetas").getContext("2d");
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{
          data: valores,
          backgroundColor: cores,
          borderColor: "#fff",
          borderWidth: 2
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: "Distribuição Geral de Gastos por Categoria"
          },
          legend: { position: "bottom" }
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });

    // Gráficos individuais por categoria
{% for d in dados %}
  new Chart(document.getElementById("pizza{{ d.id }}"), {
    type: "doughnut",
    data: {
      labels: ["Gasto", "Restante"],
      datasets: [{
        data: [{{ d.gasto }}, {{ d.restante|floatformat:2 }}],
        backgroundColor: ["#dc3545", "#dee2e6"],
        borderColor: "#fff",
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      },
      responsive: true,
      maintainAspectRatio: false
    }
  });
{% endfor %}

  });
</script>
{% endblock %}
